<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<title>Shopping Cart - 3140 Active Wear</title>
		<link rel="stylesheet" href="CSS/style.css" />
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" />
	</head>
	<body>
		<section id="header">
			<a href="index.html"><img src="Icons/logo.png" class="logo" alt="Site Logo" width="100%" height="250" /></a>
			<div>
				<ul id="navbar">
					<li><a href="index.html">Home</a></li>
					<li><a href="shop.html">Shop</a></li>
					<li><a href="donate.html">Donate</a></li>
					<li class="dropdown">
						<a class="dropbtn">
							Contact
							<i class="fa-solid fa-angle-down"></i>
						</a>
						<ul class="dropdown-content">
							<li><a href="contact.html">Contact us</a></li>
							<li><a href="about.html">About us</a></li>
						</ul>
					</li>
					<li><a href="login.html">Login/Register</a></li>
					<li>
						<div class="cart-container">
							<a href="cart.html" id="cart-icon" class="cart-hover">
								<i class="fa fa-shopping-bag" aria-hidden="true"></i>
								<span id="cart-count">0</span>
							</a>
							<div id="cart-preview" class="cart-preview">
								<h3>My Shopping Cart</h3>
								<div id="cart-items"></div>
								<div class="cart-total">
									<strong>Total:</strong>
									$
									<span id="cart-total">0.00</span>
								</div>
								<div style="margin-top: 20px; text-align: center">
									<a href="order.html" class="button-link">My Order History</a>
									<a href="cart.html" class="button-link">My Shopping Cart</a>
									<a href="checkout.html" class="button-link">Proceed to Checkout</a>
								</div>
							</div>
						</div>
					</li>
				</ul>
			</div>
		</section>

		<main id="cart-page" class="section-p1">
			<h2>My Shopping Cart</h2>
			<div id="cart-page-items-container">
				<p>Loading your cart...</p>
			</div>
			<section id="cart-summary-section">
				<div id="cart-summary">
					<h3>Cart Totals</h3>
					<div class="summary-row">
						<span>Subtotal</span>
						<span id="cart-subtotal">$0.00</span>
					</div>
					<hr />
					<div class="summary-row">
						<strong>Total</strong>
						<strong id="cart-grand-total">$0.00</strong>
					</div>
					<button class="checkout-btn" onclick="window.location.href='checkout.html'">Proceed to Checkout</button>
				</div>
			</section>
		</main>

		<footer style="padding: 20px; background: #eee; justify-content: center">
			<p style="margin: 0">&copy; 2025 CISC 3140 ACTIVE WEAR (E-commerceProject) – Built with ❤️ by student developers for education.</p>
		</footer>

		<script>
			// Global variables
			let productList = []
			const cart = {}
			let totalItems = 0

			// --- Cookie Functions ---
			function setCookie(name, value, days) {
				let expires = ""
				if (days) {
					const date = new Date()
					date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000)
					expires = "; expires=" + date.toUTCString()
				}
				document.cookie = name + "=" + (value || "") + expires + "; path=/"
			}

			function getCookie(name) {
				const nameEQ = name + "="
				const ca = document.cookie.split(";")
				for (let i = 0; i < ca.length; i++) {
					let c = ca[i]
					while (c.charAt(0) === " ") c = c.substring(1, c.length)
					if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length)
				}
				return null
			}

			// --- Cart Management Functions ---
			function saveCartToCookie() {
				setCookie("shoppingCart", JSON.stringify(cart), 7)
			}

			function loadCartFromCookie() {
				const savedCart = getCookie("shoppingCart")
				if (savedCart) {
					const parsedCart = JSON.parse(savedCart)
					Object.assign(cart, parsedCart)
					recalculateTotalItems()
				}
			}

			function recalculateTotalItems() {
				totalItems = 0
				for (const index in cart) {
					totalItems += cart[index]
				}
			}

			function updateCartCount() {
				const cartCountEl = document.getElementById("cart-count")
				if (cartCountEl) {
					cartCountEl.textContent = totalItems
				}
			}

			function updateCartPreview() {
				const container = document.getElementById("cart-items")
				const totalDisplay = document.getElementById("cart-total")
				if (!container || !totalDisplay || productList.length === 0) return

				container.innerHTML = ""
				let total = 0

				Object.keys(cart).forEach((index) => {
					const item = productList[index]
					if (!item) return // Skip if item not found in productList
					const qty = cart[index]
					const subtotal = qty * item.price
					total += subtotal

					const div = document.createElement("div")
					div.className = "cart-item"
					div.innerHTML = `${item.name} x ${qty} = $${subtotal.toFixed(2)}`
					container.appendChild(div)
				})

				totalDisplay.textContent = total.toFixed(2)
			}

			// --- Main Cart Page Functions ---

			// Renders the full cart page with detailed items and totals.
			function renderFullCart() {
				const container = document.getElementById("cart-page-items-container")
				const subtotalDisplay = document.getElementById("cart-subtotal")
				const totalDisplay = document.getElementById("cart-grand-total")
				const summarySection = document.getElementById("cart-summary-section")

				if (!container) return // Exit if the main container isn't on the page

				let total = 0
				const cartKeys = Object.keys(cart)

				if (cartKeys.length === 0) {
					container.innerHTML = "<p style='text-align:center; padding: 40px 0;'>Your cart is empty.</p>"
					if (summarySection) summarySection.style.display = "none" // Hide totals if cart is empty
					return
				}

				if (summarySection) summarySection.style.display = "flex" // Show totals if hidden
				// Create a table to display items
				container.innerHTML = `
					<table style="width:100%;">
						<thead>
							<tr>
								<td></td>
								<td></td>
								<td>Product Name</td>
								<td>Price</td>
								<td>Quantity</td>
								<td>Subtotal</td>
							</tr>
						</thead>
						<tbody></tbody>
					</table>`
				const tbody = container.querySelector("tbody")

				cartKeys.forEach((index) => {
					const item = productList[index]
					if (!item) return // Safety check
					const qty = cart[index]
					const subtotal = qty * item.price
					total += subtotal

					const itemRow = document.createElement("tr")
					itemRow.innerHTML = `
						<td><button class="remove-btn" onclick="changeQty(${index}, -${qty})">×</button></td>
						<td><img src="${item.img}" alt="${item.name}"></td>
						<td>${item.name}</td>
						<td>$${item.price.toFixed(2)}</td>
						<td>
							<div class="quantity-controls-cart">
								<button onclick="changeQty(${index}, -1)">−</button>
								<span>${qty}</span>
								<button onclick="changeQty(${index}, 1)">+</button>
							</div>
						</td>
						<td><strong>$${subtotal.toFixed(2)}</strong></td>`
					tbody.appendChild(itemRow)
				})

				subtotalDisplay.textContent = `$${total.toFixed(2)}`
				totalDisplay.textContent = `$${total.toFixed(2)}`
			}

			// Handles quantity changes initiated from the cart page
			function changeQty(index, delta) {
				if (cart[index]) {
					cart[index] += delta

					if (cart[index] <= 0) {
						delete cart[index]
					}

					recalculateTotalItems()
					updateCartCount()
					updateCartPreview()
					saveCartToCookie()
					renderFullCart() // Always re-render the main cart view after a change
				}
			}

			// --- Initial Page Load Sequence ---
			document.addEventListener("DOMContentLoaded", () => {
				fetch("products.json")
					.then((response) => {
						if (!response.ok) {
							throw new Error("Network response was not ok " + response.statusText)
						}
						return response.json()
					})
					.then((data) => {
						productList = data
						loadCartFromCookie()

						// Update all cart-related displays
						updateCartCount()
						updateCartPreview()
						renderFullCart() // Main function for rendering this page
					})
					.catch((error) => {
						console.error("Error fetching products:", error)
						const cartPage = document.getElementById("cart-page-items-container")
						if (cartPage) {
							cartPage.innerHTML = '<p style="text-align: center; color: red;">Could not load product data. Please try again later.</p>'
						}
					})
			})
		</script>
	</body>
</html>
